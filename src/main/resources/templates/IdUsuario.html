<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
    <title>Editar Usuario</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>

<div class="container mt-4">
    <div class="card shadow-lg border-warning">
        <div class="card-header bg-warning text-dark">
            <h3 class="mb-0"><i class="bi bi-pencil-square"></i> Editar Información</h3>
        </div>
        
        <div class="card-body">
            <form th:action="@{/usuario/add}" method="post" th:object="${usuario}" id="formUsuario">
                
                <input type="hidden" th:field="*{IdUsuario}" />

                <h5 class="text-secondary mb-3">Datos Personales</h5>
                <div class="row g-3 mb-3">
                    <div class="col-12 col-md-4">
                        <label class="form-label">Nombre</label>
                        <input type="text" class="form-control" th:field="*{Nombre}">
                    </div>
                    <div class="col-12 col-md-4">
                        <label class="form-label">Apellido Paterno</label>
                        <input type="text" class="form-control" th:field="*{ApellidoPaterno}">
                    </div>
                    <div class="col-12 col-md-4">
                        <label class="form-label">Apellido Materno</label>
                        <input type="text" class="form-control" th:field="*{ApellidoMaterno}">
                    </div>
                </div>

                <div class="row g-3 mb-3">
                    <div class="col-12 col-md-4">
                        <label class="form-label">Correo</label>
                        <input type="email" class="form-control" th:field="*{Email}">
                    </div>
                    <div class="col-12 col-md-4">
                        <label class="form-label">Contraseña</label>
                        <input type="text" class="form-control" th:field="*{Password}">
                    </div>
                    <div class="col-12 col-md-4">
                        <label class="form-label">CURP</label>
                        <input type="text" class="form-control" th:field="*{Curp}">
                    </div>
                </div>
                
                 <div class="row g-3 mb-3">
                    <div class="col-12 col-md-4">
                        <label class="form-label">Fecha Nacimiento</label>
                        <input type="date" class="form-control" th:field="*{FechaNacimiento}">
                    </div>
                    <div class="col-12 col-md-4">
                        <label class="form-label">Sexo</label>
                        <select class="form-select" th:field="*{Sexo}">
                            <option value="M">Masculino</option>
                            <option value="F">Femenino</option>
                        </select>
                    </div>
                    <div class="col-12 col-md-4">
                        <label class="form-label">Rol</label>
                        <select class="form-select" th:field="*{Rol.Id}">
                            <option value="0">Seleccione</option>
                            <option th:each="r : ${Roles}" th:value="${r.Id}" th:text="${r.Rol}"></option>
                        </select>
                    </div>
                </div>
                
                 <div class="row g-3 mb-4">
                     <div class="col-12 col-md-4">
                        <label class="form-label">Teléfono</label>
                        <input type="text" class="form-control" th:field="*{Telefono}">
                    </div>
                     <div class="col-12 col-md-4">
                        <label class="form-label">Celular</label>
                        <input type="text" class="form-control" th:field="*{Celular}">
                    </div>
                </div>

                <hr>

                <h5 class="text-secondary mb-3">Dirección Registrada</h5>

                <div th:if="${usuario.Direcciones != null and !usuario.Direcciones.isEmpty()}">
                    
                    <input type="hidden" id="txtIdPais" th:value="${usuario.Direcciones[0].Colonia.Municipio.Estado.Pais.IdPais}" />
                    <input type="hidden" id="txtIdEstado" th:value="${usuario.Direcciones[0].Colonia.Municipio.Estado.IdEstado}" />
                    <input type="hidden" id="txtIdMunicipio" th:value="${usuario.Direcciones[0].Colonia.Municipio.IdMunicipio}" />
                    <input type="hidden" id="txtIdColonia" th:value="${usuario.Direcciones[0].Colonia.IdColonia}" />

                    <div class="row g-3 mb-3">
                        <div class="col-12 col-md-6">
                            <label class="form-label">Calle</label>
                            <input type="text" class="form-control" th:field="*{Direcciones[0].Calle}">
                        </div>
                        <div class="col-6 col-md-3">
                            <label class="form-label">No. Ext</label>
                            <input type="text" class="form-control" th:field="*{Direcciones[0].NumeroExterior}">
                        </div>
                        <div class="col-6 col-md-3">
                            <label class="form-label">No. Int</label>
                            <input type="text" class="form-control" th:field="*{Direcciones[0].NumeroInterior}">
                        </div>
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-12 col-md-3">
                            <label class="form-label">País</label>
                            <select class="form-select" id="ddlPais">
                                <option value="0">Seleccione</option>
                                <option th:each="p : ${Pais}" th:value="${p.IdPais}" th:text="${p.Nombre}"></option>
                            </select>
                        </div>
                        <div class="col-12 col-md-3">
                            <label class="form-label">Estado</label>
                            <select class="form-select" id="ddlEstado">
                                <option value="0">Seleccione un País</option>
                            </select>
                        </div>
                        <div class="col-12 col-md-3">
                            <label class="form-label">Municipio</label>
                            <select class="form-select" id="ddlMunicipio">
                                <option value="0">Seleccione un Estado</option>
                            </select>
                        </div>
                        <div class="col-12 col-md-3">
                            <label class="form-label">Colonia</label>
                            <select class="form-select" id="ddlColonia" name="Direcciones[0].Colonia.IdColonia">
                                <option value="0">Seleccione un Municipio</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div th:unless="${usuario.Direcciones != null and !usuario.Direcciones.isEmpty()}" class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i> Este usuario no tiene dirección registrada.
                </div>

                <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                    <button type="submit" class="btn btn-warning me-md-2">
                        <i class="bi bi-check-lg"></i> Actualizar
                    </button>
                    <a th:href="@{/usuario/Inicio}" class="btn btn-secondary" onclick="confirmarSalida(event, this.href)">Regresar</a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    $(document).ready(function() {

        var savedIdPais = $("#txtIdPais").val();
        var savedIdEstado = $("#txtIdEstado").val();
        var savedIdMunicipio = $("#txtIdMunicipio").val();
        var savedIdColonia = $("#txtIdColonia").val();

        if(savedIdPais > 0) {
            $("#ddlPais").val(savedIdPais);
            cargarEstados(savedIdPais);
        }

        $("#ddlPais").change(function() {
            var idPais = $(this).val();
            cargarEstados(idPais);
        });

        $("#ddlEstado").change(function() {
            var idEstado = $(this).val();
            cargarMunicipios(idEstado);
        });

        $("#ddlMunicipio").change(function() {
            var idMunicipio = $(this).val();
            cargarColonias(idMunicipio);
        });

        function cargarEstados(idPais) {
            if (idPais > 0) {
                $.ajax({
                    url: "/usuario/getEstadosByPais/" + idPais,
                    type: "GET",
                    dataType: "json",
                    success: function(res) {
                        $("#ddlEstado").empty().append('<option value="0">Seleccione</option>');
                        var lista = res.Objects || res.objects; 
                        $.each(lista, function(i, item) {
                            $("#ddlEstado").append('<option value="'+ (item.IdEstado || item.idEstado) +'">'+ (item.Nombre || item.nombre) +'</option>');
                        });

                        if(savedIdEstado > 0 && $("#ddlPais").val() == savedIdPais) {
                            $("#ddlEstado").val(savedIdEstado);
                            cargarMunicipios(savedIdEstado);
                        }
                    },
                    error: function() {
                        console.error("Error al cargar estados");
                    }
                });
            } else {
                $("#ddlEstado").empty().append('<option value="0">Seleccione un País</option>');
                $("#ddlMunicipio").empty().append('<option value="0">Seleccione un Estado</option>');
                $("#ddlColonia").empty().append('<option value="0">Seleccione un Municipio</option>');
            }
        }

        function cargarMunicipios(idEstado) {
            if (idEstado > 0) {
                $.ajax({
                    url: "/usuario/MunicipioByEstado/" + idEstado,
                    type: "GET",
                    dataType: "json",
                    success: function(res) {
                        $("#ddlMunicipio").empty().append('<option value="0">Seleccione</option>');
                        var lista = res.Objects || res.objects;
                        $.each(lista, function(i, item) {
                            $("#ddlMunicipio").append('<option value="'+ (item.IdMunicipio || item.idMunicipio) +'">'+ (item.Nombre || item.nombre) +'</option>');
                        });

                        if(savedIdMunicipio > 0 && $("#ddlEstado").val() == savedIdEstado) {
                            $("#ddlMunicipio").val(savedIdMunicipio);
                            cargarColonias(savedIdMunicipio);
                        }
                    },
                    error: function() {
                        console.error("Error al cargar municipios");
                    }
                });
            } else {
                $("#ddlMunicipio").empty().append('<option value="0">Seleccione un Estado</option>');
                $("#ddlColonia").empty().append('<option value="0">Seleccione un Municipio</option>');
            }
        }

        function cargarColonias(idMunicipio) {
            if (idMunicipio > 0) {
                $.ajax({
                    url: "/usuario/ColoniaByMunicipio/" + idMunicipio,
                    type: "GET",
                    dataType: "json",
                    success: function(res) {
                        $("#ddlColonia").empty().append('<option value="0">Seleccione</option>');
                        var lista = res.Objects || res.objects;
                        if(lista) {
                            $.each(lista, function(i, item) {
                                $("#ddlColonia").append('<option value="'+ (item.IdColonia || item.idColonia) +'">'+ (item.Nombre || item.nombre) +'</option>');
                            });

                            if(savedIdColonia > 0 && $("#ddlMunicipio").val() == savedIdMunicipio) {
                                $("#ddlColonia").val(savedIdColonia);
                            }
                        }
                    },
                    error: function() {
                        console.error("Error al cargar colonias");
                    }
                });
            } else {
                $("#ddlColonia").empty().append('<option value="0">Seleccione un Municipio</option>');
            }
        }

        $('#formUsuario').on('submit', function(e) {
            e.preventDefault();
            
            var form = this;

            Swal.fire({
                title: '¿Confirmar actualización?',
                text: "Verifica que los datos sean correctos antes de guardar.",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#ffc107', 
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Sí, actualizar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({
                        title: 'Guardando...',
                        text: 'Por favor espere',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });
                    
                    setTimeout(function() {
                        form.submit();
                    }, 800);
                }
            });
        });
    });

    function confirmarSalida(event, url) {
        event.preventDefault();
        Swal.fire({
            title: '¿Salir sin guardar?',
            text: "Se perderán los cambios no guardados.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Sí, salir',
            cancelButtonText: 'Permanecer'
        }).then((result) => {
            if (result.isConfirmed) {
                window.location.href = url;
            }
        });
    }
</script>

</body>
</html>